<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üë§ Usuarios | Store</title>

  <!-- Evita parpadeo hasta verificar rol -->
  <style>html{visibility:hidden}</style>

  <!-- Guard OWNER: JWT -> /auth/me (8088) -->
  <script>
  (function(){
    const API_ME = 'http://localhost:8088/auth/me';

    const token = localStorage.getItem('accessToken') || localStorage.getItem('token') ||
                  sessionStorage.getItem('accessToken') || sessionStorage.getItem('token');

    const show = ()=>{ document.documentElement.style.visibility='visible'; };
    const go = (p)=>{ location.replace(p); };

    if (!token) { go('login.html'); return; }

    function b64u(s){ try { return atob(s.replace(/-/g,'+').replace(/_/g,'/')); } catch(_) { return ''; } }
    function parseJwt(tok){
      try{
        const p = tok.split('.')[1] || '';
        const json = decodeURIComponent(Array.prototype.map.call(b64u(p), c =>
          '%' + ('00'+c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));
        return JSON.parse(json);
      }catch(_){ return {}; }
    }
    function hasOwnerRole(obj){
      const set = new Set();
      const add = v => v && set.add(String(v).toUpperCase());
      const many = a => Array.isArray(a) && a.forEach(x => add(typeof x==='string'?x:(x&&x.authority)));
      many(obj.roles); many(obj.role); many(obj.authorities);
      if (typeof obj.scope==='string') obj.scope.split(/\s+/).forEach(add);
      return set.has('ROLE_OWNER') || set.has('OWNER');
    }

    const payload = parseJwt(token);
    if (hasOwnerRole(payload)) { show(); return; }

    fetch(API_ME, { headers:{ 'Authorization':'Bearer '+token }})
      .then(r => r.ok ? r.json() : null)
      .then(me => {
        const role = ((me && (me.role||me.roles))||'').toString().toUpperCase();
        const ok = role.includes('ROLE_OWNER') || role.includes('OWNER');
        ok ? show() : go('index.html');
      })
      .catch(() => go('index.html'));
  })();
  </script>

  <link rel="stylesheet" href="../files-css/style.css"/>
  <link rel="stylesheet" href="../files-css/dashboard.css"/>
  <link rel="stylesheet" href="../files-css/usuarios.css"/>
  <link rel="stylesheet" href="../files-css/nav.css"/>

  <!-- SweetAlert2 (si ya lo ten√©s local, reemplaz√° este src por tu archivo local) -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div id="app-header"></div>

  <main class="wrap">
    <h1>Administraci√≥n de usuarios</h1>
    <p class="muted">S√≥lo disponible para <b>OWNER</b>.</p>

    <section class="grid">
      <section class="card">
        <div class="card-head"><h3>Nuevo usuario</h3></div>
        <form id="fNew">
          <input name="username" placeholder="Usuario" required />
          <input name="email" placeholder="Email" type="email" />
          <input name="name" placeholder="Nombre" />
          <input name="lastName" placeholder="Apellido" />
          <input name="phone" placeholder="Tel√©fono" />
          <select name="role" required>
            <option value="ROLE_EMPLOYEE">Empleado</option>
            <option value="ROLE_OWNER">Owner</option>
          </select>
          <input class="full" name="password" type="password" placeholder="Contrase√±a" required />
          <button class="btn" id="btnCreate">Crear</button>
        </form>
        <p id="nMsg" class="muted"></p>
      </section>

      <section class="card">
        <div class="card-head"><h3>Reset de contrase√±a</h3></div>
        <form id="fReset">
          <input name="userId" placeholder="ID de usuario" required />
          <input name="password" type="password" placeholder="Nueva contrase√±a" required />
          <button class="btn" id="btnReset">Actualizar</button>
        </form>
        <p id="rMsg" class="muted"></p>
      </section>
    </section>

    <section class="card" style="margin-top:16px;">
      <div class="card-head">
        <h3>Usuarios</h3>
        <button id="btnReload" class="btn outline">Recargar</button>
      </div>
      <div class="tabla compact" id="tbl">
        <div class="fila encabezado">
          <div>Usuario</div><div>Nombre</div><div>Email</div><div>Rol</div><div>Activo</div><div>Acciones</div>
        </div>
      </div>
    </section>
  </main>

  <!-- Header + men√∫ usuario (igual que el resto) -->
  <script src="../files-js/core/api.js"></script>
  <script>window.api.setBaseUrl('http://localhost:8088');</script>
  <script src="../files-js/header.js"></script>
  <script src="../files-js/role-guard.js"></script>
  <script src="../files-js/menu-guard.js"></script>

  <script>
    const { authFetch, safeJson, getToken } = window.api;

    const API_USERS = '/users';
    const API_ME    = '/auth/me';

    if(!getToken()){ location.href='login.html'; }

    const $ = s=>document.querySelector(s);

    let selfId = null;

    const Toast = Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 2200,
      timerProgressBar: true
    });

    function toastOk(text){ Toast.fire({ icon:'success', title: text }); }
    function toastErr(text){ Toast.fire({ icon:'error', title: text }); }

    async function readErr(r){
      try{
        const j = await safeJson(r);
        if (j && (j.message || j.error)) return String(j.message || j.error);
        const t = await r.text();
        return (t||'').trim() || ('HTTP ' + r.status);
      }catch{
        return ('HTTP ' + r.status);
      }
    }

    async function whoAmI(){
      try{
        const r = await authFetch(API_ME);
        if(!r.ok) return null;
        return await safeJson(r);
      }catch{ return null; }
    }

    async function load(){
      const me = await whoAmI();
      selfId = me && (me.id || me.userId || me.sub) || null;

      const r = await authFetch(API_USERS);
      if(!r.ok){
        const msg = await readErr(r);
        await Swal.fire({ icon:'error', title:'No autorizado', text: msg || 'No ten√©s permisos.' });
        location.href='index.html';
        return;
      }
      const list = await safeJson(r);
      render(Array.isArray(list) ? list : []);
    }

    function render(list){
      const host = $('#tbl');
      host.querySelectorAll('.filaUsr').forEach(n=>n.remove());

      list.forEach(u=>{
        const isSelf = selfId && String(u.id) === String(selfId);
        const nextRole = u.role==='ROLE_OWNER'?'ROLE_EMPLOYEE':'ROLE_OWNER';

        const row=document.createElement('div');
        row.className='fila filaUsr';
        row.innerHTML=`
          <div>${u.username}</div>
          <div>${(u.name||'')+' '+(u.lastName||'')}</div>
          <div>${u.email||''}</div>
          <div>
            <span class="pill role ${u.role==='ROLE_OWNER' ? 'owner' : ''}">
              ${(u.role||'').replace('ROLE_','')}
            </span>
          </div>
          <div>${u.enabled? '‚úîÔ∏è' : '‚ùå'}</div>
          <div style="display:flex; gap:6px; flex-wrap:wrap;">
            <button class="btn outline" data-act="role" data-id="${u.id}" data-role="${nextRole}" ${isSelf?'disabled':''}>
              ${u.role==='ROLE_OWNER'?'Hacer Empleado':'Hacer Owner'}
            </button>
            <button class="btn outline" data-act="toggle" data-id="${u.id}" data-enabled="${u.enabled ? '1':'0'}" ${isSelf?'disabled':''}>
              ${u.enabled?'Desactivar':'Activar'}
            </button>
            <button class="btn outline" data-act="reset" data-id="${u.id}">Reset pass</button>
            <button class="btn outline" data-act="del" data-id="${u.id}" ${isSelf?'disabled':''}>Eliminar</button>
          </div>
        `;
        host.appendChild(row);
      });

      host.onclick = async (ev)=>{
        const btn = ev.target.closest('button[data-act]'); if(!btn || btn.disabled) return;
        const id = btn.dataset.id;
        const act= btn.dataset.act;

        if (act==='del'){
          const res = await Swal.fire({
            icon:'warning',
            title:'Eliminar usuario',
            text:'Esta acci√≥n no se puede deshacer.',
            showCancelButton:true,
            confirmButtonText:'S√≠, eliminar',
            cancelButtonText:'Cancelar'
          });
          if(!res.isConfirmed) return;

          const r = await authFetch(`${API_USERS}/${id}`,{ method:'DELETE' });
          if(r.ok){ toastOk('Usuario eliminado'); load(); }
          else { toastErr(await readErr(r)); }

        } else if (act==='toggle'){
          const currentlyEnabled = btn.dataset.enabled === '1';
          const enable = !currentlyEnabled;

          const res = await Swal.fire({
            icon:'question',
            title: enable ? 'Activar usuario' : 'Desactivar usuario',
            text: enable ? 'El usuario podr√° iniciar sesi√≥n.' : 'El usuario NO podr√° iniciar sesi√≥n.',
            showCancelButton:true,
            confirmButtonText: enable ? 'Activar' : 'Desactivar',
            cancelButtonText:'Cancelar'
          });
          if(!res.isConfirmed) return;

          const r = await authFetch(`${API_USERS}/${id}`,{
            method:'PATCH',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ enabled: enable })
          });
          if(r.ok){ toastOk('Actualizado'); load(); }
          else { toastErr(await readErr(r)); }

        } else if (act==='role'){
          const role = btn.dataset.role;

          const res = await Swal.fire({
            icon:'question',
            title:'Cambiar rol',
            text:`¬øConfirm√°s cambiar el rol a ${role.replace('ROLE_','')}?`,
            showCancelButton:true,
            confirmButtonText:'Cambiar',
            cancelButtonText:'Cancelar'
          });
          if(!res.isConfirmed) return;

          const r = await authFetch(`${API_USERS}/${id}`,{
            method:'PATCH',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ role })
          });
          if(r.ok){ toastOk('Rol actualizado'); load(); }
          else { toastErr(await readErr(r)); }

        } else if (act==='reset'){
          const res = await Swal.fire({
            title:'Nueva contrase√±a',
            input:'password',
            inputPlaceholder:'Ingres√° la nueva contrase√±a',
            inputAttributes:{ autocomplete:'new-password' },
            showCancelButton:true,
            confirmButtonText:'Actualizar',
            cancelButtonText:'Cancelar',
            inputValidator: (v)=> !v ? 'Ingres√° una contrase√±a' : undefined
          });
          if(!res.isConfirmed) return;

          const r = await authFetch(`${API_USERS}/${id}`,{
            method:'PATCH',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ password: res.value })
          });
          if(r.ok){ toastOk('Contrase√±a actualizada'); }
          else { toastErr(await readErr(r)); }
        }
      };
    }

    $('#fNew').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const btn = $('#btnCreate');
      btn.disabled = true;

      try{
        const fd = new FormData(e.target);
        const body = JSON.stringify(Object.fromEntries(fd.entries()));
        const r = await authFetch(API_USERS,{ method:'POST', headers:{ 'Content-Type':'application/json' }, body });

        if (r.ok){
          $('#nMsg').textContent = 'Usuario creado';
          toastOk('Usuario creado');
          e.target.reset();
          load();
        } else {
          const msg = await readErr(r);
          $('#nMsg').textContent = 'No se pudo crear';
          await Swal.fire({ icon:'error', title:'No se pudo crear', text: msg });
        }
      } finally {
        btn.disabled = false;
      }
    });

    $('#fReset').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const btn = $('#btnReset');
      btn.disabled = true;

      try{
        const fd = new FormData(e.target);
        const id = fd.get('userId');
        const pwd= fd.get('password');

        const r = await authFetch(`${API_USERS}/${id}`,{
          method:'PATCH',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ password: pwd })
        });

        if (r.ok){
          $('#rMsg').textContent = 'Contrase√±a actualizada';
          toastOk('Contrase√±a actualizada');
          e.target.reset();
        } else {
          const msg = await readErr(r);
          $('#rMsg').textContent = 'No se pudo actualizar';
          await Swal.fire({ icon:'error', title:'No se pudo actualizar', text: msg });
        }
      } finally {
        btn.disabled = false;
      }
    });

    $('#btnReload').addEventListener('click', load);
    load();
  </script>
</body>
</html>