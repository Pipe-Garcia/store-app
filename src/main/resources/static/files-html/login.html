<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ingresar | Store</title>
  <link rel="stylesheet" href="../files-css/login.css"/>
</head>
<body class="login-body">
  <main class="auth-shell">
    <section class="auth-card">
      <header class="auth-head">
        <div class="brand">
          <div class="logo">üõí</div>
          <h1>Store</h1>
        </div>
        <h2>Bienvenido</h2>
        <p class="muted">Ingres√° con tu usuario y contrase√±a</p>
      </header>

      <form class="auth-form" id="loginForm" novalidate>
        <label class="field">
          <span>Usuario</span>
          <input id="username" name="username" type="text" autocomplete="username" required autofocus />
        </label>

        <label class="field">
          <span>Contrase√±a</span>
          <input id="password" name="password" type="password" autocomplete="current-password" required />
        </label>

        
        <div class="row between" style="display:none">
          <label class="check">
            <input id="remember" type="checkbox" checked disabled aria-hidden="true" tabindex="-1" />
          </label>
        </div>
 
        <button id="btnLogin" type="submit" class="btn primary">
          <span class="btn-text">Ingresar</span>
          <span class="spinner" aria-hidden="true"></span>
        </button>

        <p id="message" class="msg" role="alert" aria-live="polite"></p>
      </form>

      <footer class="auth-foot muted">
        <small>¬© <span id="y"></span> Store ‚Äî Todos los derechos reservados</small>
      </footer>
    </section>
  </main>

  
  <script src="../files-js/core/api.js"></script>

  <script>
    const $ = s => document.querySelector(s);
    const msg = $('#message');
    const btn = $('#btnLogin');

    function setLoading(on){
      btn.disabled = on;
      btn.classList.toggle('loading', on);
    }

    function saveYear(){ $('#y').textContent = new Date().getFullYear(); }
    saveYear();

    // Si ya hay token v√°lido, redirigimos a index
    (async function maybeRedirect(){
      const r = await api.me();
      if (r.ok) {
        const params = new URLSearchParams(location.search);
        const next = params.get('next');
        location.href = next || 'index.html';
      }
    })();

    $('#loginForm').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      msg.textContent = '';
      setLoading(true);
      try{
        const username = $('#username').value.trim();
        const password = $('#password').value;
        const remember = true; // persistente en localStorage

        const r = await api.login(username, password, { remember });
        if (r.ok) {
          // doble chequeo opcional
          const me = await api.me();
          if (me.ok) {
            const params = new URLSearchParams(location.search);
            const next = params.get('next');
            location.href = next || 'index.html';
          }
          else msg.textContent = 'No se pudo validar la sesi√≥n.';
        } else {
          msg.textContent = (r.message && r.message !== 'Invalid credentials')
            ? r.message
            : 'Usuario o contrase√±a inv√°lidos.';
        }
      } catch(e){
        msg.textContent = 'Error de red. Intent√° nuevamente.';
      } finally {
        setLoading(false);
      }
    });
  </script>

</body>
</html>
